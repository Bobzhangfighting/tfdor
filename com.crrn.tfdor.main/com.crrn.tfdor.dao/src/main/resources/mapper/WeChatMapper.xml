<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.crrn.tfdor.dao.WeChantDao">
	<!-- 插入AccessToken表 -->
	<insert id="iAccessToken" parameterType="java.util.HashMap">
		INSERT INTO AccessToken(accessToken,channelId,invalidTime,createTime,updateTime) VALUES(#{accessToken},#{channelId},#{invalidTime},now(),now())
	</insert>
   	<!-- 删除过期的accesstoken -->
   	<delete id="dAccessToken" parameterType="java.lang.String">
   		DELETE FROM AccessToken where mchId = #{mchId}
   	</delete>
   	<select id="qAccessToken" resultType="java.util.HashMap" parameterType="java.lang.String">
   		SELECT tokenSeq,accessToken,invalidTime,createTime,updateTime from AccessToken a,Merchant m where m.mchId = a.mchId and m.appId = #{appId}
   	</select>
	<select id="iQrcodeimg" parameterType="java.util.HashMap">
		INSERT INTO qrcodeimg (qrcodeSeq, CreateQISeq, mchId, sceneStr, ticket, url, qrcodeName, state, createTime, updateTime)
		VALUES (#{CreateQISeq},#{mchId}, #{sceneStr}, #{ticket}, #{url}, #{qrcodeName}, 'I', now(), now())
	</select>
	<select id="qQrcodeimg" resultType="com.crrn.tfdor.domain.wechat.QrcodeImg">
		SELECT actionName,appId,createTime,preservation,qrcodeName,qrcodeSeq,sceneId,state,ticket,updateTime,url FROM qrcodeimg
	</select>

	<update id="uQrcodeImg" parameterType="java.util.HashMap">
		UPDATE qrcodeimg SET state = #{state},updateTime = now() WHERE ticket = #{Ticket}
	</update>
	<select id="qChannel" resultType="com.crrn.tfdor.domain.manage.Channel" parameterType="java.lang.String">
		select * from channel where channelId = #{channelId}
	</select>

	<select id="queryRedPack" parameterType="java.util.HashMap" resultType="com.crrn.tfdor.domain.wechat.RedPackBean">
		SELECT redPackSeq, redPackType, amountType, totalAmount, wishing, actName, remark,
				DATE_FORMAT(createTime, '%Y-%m-%d %H:%i:%s') createTime,
          		DATE_FORMAT(updateTime, '%Y-%m-%d %H:%i:%s') updateTime
				FROM redpack  WHERE channelId = #{channelId}
	</select>

	<select id="qCreateQrcodeImg" parameterType="java.util.HashMap" resultType="java.util.List">
		select cl.channelId,cl.channelName,c.createQISeq,c.mchId,c.beginDate,c.actionName,c.endDate,c.number,
		c.preservation,c.createTime,DATE_FORMAT(c.updateTime,'%Y-%m-%d %H:%i:%s') updateTime,m.mchName,c.state,c.expireSeconds
		from CreateQrcodeImg c,Merchant m,channel cl  WHERE m.mchId = c.mchId and m.channelId = cl.channelId
		<if test="channelId != null and channelId != ''">
			AND cl.channelId = #{channelId}
		</if>
	</select>

	<insert id="iCreateQrcodeImage" parameterType="com.crrn.tfdor.domain.wechat.CreateQrcodeImg" keyProperty="createQISeq"  useGeneratedKeys="true">
		INSERT INTO createqrcodeimg (mchId, beginDate, actionName, endDate, expireSeconds, number, preservation, state, createTime, updateTime)
		VALUES (#{mchId}, #{beginDate}, #{actionName}, #{endDate}, #{expireSeconds}, #{number}, #{preservation}, #{state}, now(), now());
	</insert>
	
	<select id="qMerchant" parameterType="java.lang.String" resultType="com.crrn.tfdor.domain.manage.Merchant">
		select * FROM merchant where appId = #{appId}
	</select>
</mapper>
